# TAEHVè®­ç»ƒé¡¹ç›®è¿›å±•æŠ¥å‘Š - 2025å¹´9æœˆ29æ—¥

## ğŸ“‹ æ¦‚è¦

æœ¬æŠ¥å‘Šæ€»ç»“äº†TAEHV (Tiny AutoEncoder for Hunyuan Video) è®­ç»ƒé¡¹ç›®åœ¨2025å¹´9æœˆ29æ—¥çš„ä¸»è¦è¿›å±•å’Œä¼˜åŒ–æ”¹è¿›ã€‚

## ğŸ¯ é¡¹ç›®ç›®æ ‡

åŸºäº`checkpoints/taecvx.pth`é¢„è®­ç»ƒæ¨¡å‹ï¼Œç»“åˆ`models/taehv.py`æ ¸å¿ƒä»£ç ï¼Œåˆ©ç”¨`/data/matrix-project/MiniDataset`æ•°æ®é›†é‡æ–°è®­ç»ƒä¸€ä¸ªé€‚é…è‡ªå®šä¹‰æ•°æ®çš„TAEHVæ¨¡å‹ã€‚

## ğŸš€ ä¸»è¦è¿›å±•

### 1. é¡¹ç›®ç»“æ„é‡ç»„å®Œæˆ

#### 1.1 é…ç½®å‚æ•°åŒ– âœ…
- **æˆæœ**ï¼šå®ç°"æ‰€æœ‰å¯è°ƒæ•´å‚æ•°éƒ½åœ¨config.pyé‡Œ"çš„ç›®æ ‡
- **æ–‡ä»¶**ï¼š`training/configs/taehv_config.py`
- **å½±å“**ï¼šç”¨æˆ·åªéœ€ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œæ— éœ€åˆ°å¤„æ”¹ä»£ç 

#### 1.2 æ¨¡å—åŒ–æ¶æ„ âœ…
```
training/
â”œâ”€â”€ configs/taehv_config.py    # ç»Ÿä¸€é…ç½®ä¸­å¿ƒ
â”œâ”€â”€ taehv_train.py             # æ ¸å¿ƒè®­ç»ƒè„šæœ¬
â”œâ”€â”€ dataset.py                 # æ•°æ®é›†å¤„ç†
â””â”€â”€ utils.py                   # å·¥å…·å‡½æ•°
```

### 2. è®­ç»ƒç³»ç»Ÿä¼˜åŒ–

#### 2.1 DeepSpeedé›†æˆ âœ…
- **é…ç½®æ–‡ä»¶**ï¼š`accelerate_configs/deepspeed.yaml`
- **ç‰¹æ€§**ï¼šZeRO Stage 2 + CPU Offload
- **æ•ˆæœ**ï¼šæ”¯æŒæ›´å¤§batch sizeå’Œæ¨¡å‹å‚æ•°

#### 2.2 å®¹é”™æœºåˆ¶å¢å¼º âœ…
```python
# æ–°å¢åŠŸèƒ½
- æ¢¯åº¦å¼‚å¸¸æ£€æµ‹å’Œè·³è¿‡
- GPU OOMè‡ªåŠ¨æ¢å¤
- æ£€æŸ¥ç‚¹ä¿å­˜å¤±è´¥å®¹é”™
- å†…å­˜ç¢ç‰‡å®šæœŸæ¸…ç†
- é€šä¿¡è¶…æ—¶ä¼˜åŒ–
```

#### 2.3 è®­ç»ƒå‚æ•°ä¼˜åŒ– âœ…
| å‚æ•° | è°ƒæ•´å‰ | è°ƒæ•´å | åŸå›  |
|-----|--------|--------|------|
| `train_batch_size` | 4 | 2 | é¿å…NCCLé€šä¿¡è¶…æ—¶ |
| `gradient_accumulation_steps` | 1 | 2 | ç»´æŒæœ‰æ•ˆbatch size=4 |
| `resume_from_checkpoint` | None | `output/2025-09-29_22-24-51/checkpoint-5500` | æ”¯æŒæ–­ç‚¹ç»­è®­ |

### 3. è·¯å¾„é…ç½®ä¼˜åŒ– ğŸ”§

#### 3.1 é—®é¢˜è§£å†³
- **é—®é¢˜**ï¼šCogVideoX-2bè·¯å¾„ç¡¬ç¼–ç åœ¨utils.pyä¸­
- **è§£å†³**ï¼šè¿ç§»åˆ°é…ç½®æ–‡ä»¶ï¼Œæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰è·¯å¾„

#### 3.2 çµæ´»æ€§æå‡
```python
# é…ç½®æ–‡ä»¶ä¸­
args.cogvideox_model_path = "CogVideoX-2b"  # æœ¬åœ°è·¯å¾„
args.use_ref_vae = True                     # å¯å¼€å…³å‚è€ƒVAE

# æ”¯æŒå¤šç§é€‰æ‹©ï¼š
# - æœ¬åœ°è·¯å¾„ï¼š"/path/to/CogVideoX-2b"
# - HuggingFaceï¼š      "THUDM/CogVideoX-2b" 
# - å®Œå…¨ç¦ç”¨ï¼šargs.use_ref_vae = False
```

### 4. Seraenaå¯¹æŠ—è®­ç»ƒé›†æˆ ğŸ¯

#### 4.1 æ¨¡å—ä¿ç•™
- **å†³ç­–**ï¼šä¿ç•™`models/seraena.py`ä½œä¸ºå¯é€‰ç»„ä»¶
- **ç†ç”±**ï¼šå¯¹æŠ—è®­ç»ƒæœ‰åŠ©äºæå‡é‡å»ºè´¨é‡
- **æ§åˆ¶**ï¼šé€šè¿‡`args.use_seraena = True/False`å¼€å…³

#### 4.2 æŠ€æœ¯é›†æˆ
```python
# æ¡ä»¶åŠ è½½
if config.use_seraena:
    seraena = Seraena(3 * config.n_seraena_frames, 16)
    
# æ¡ä»¶è®­ç»ƒ
if seraena is not None:
    seraena_loss = calculate_seraena_loss(...)
    total_loss += config.seraena_loss_weight * seraena_loss
```

## ğŸ› ï¸ æŠ€æœ¯äº®ç‚¹

### 1. å†…å­˜ç®¡ç†ä¼˜åŒ–
```python
# å®šæœŸå†…å­˜æ¸…ç†ï¼ˆæ¯100æ­¥ï¼‰
if global_step % 100 == 0:
    torch.cuda.empty_cache()
    gc.collect()

# å†…å­˜ç›‘æ§ï¼ˆæ¯50æ­¥ï¼‰
memory_allocated = torch.cuda.memory_allocated() / 1024**3
logger.info(f"GPU Memory: {memory_allocated:.2f}GB")
```

### 2. DeepSpeedå…¼å®¹æ€§
```python
# æ¢¯åº¦è£å‰ªé€‚é…
if accelerator.distributed_type != DistributedType.DEEPSPEED:
    grad_norm = accelerator.clip_grad_norm_(model.parameters(), config.max_grad_norm)
# else: DeepSpeedè‡ªåŠ¨å¤„ç†
```

### 3. æ£€æŸ¥ç‚¹ç³»ç»ŸåŠ å›º
```python
# ä¿å­˜å‰ååŒæ­¥
accelerator.wait_for_everyone()
try:
    accelerator.save_state(save_path)
    logger.info(f"âœ… Checkpoint saved: {save_path}")
except Exception as e:
    logger.error(f"âŒ Save failed: {e}")
    # ç»§ç»­è®­ç»ƒè€Œä¸æ˜¯å´©æºƒ
accelerator.wait_for_everyone()
```

## ğŸ“Š è®­ç»ƒçŠ¶æ€

### å½“å‰é…ç½®
```python
# æ ¸å¿ƒå‚æ•°
train_batch_size = 2
gradient_accumulation_steps = 2  # æœ‰æ•ˆbatch size = 4
learning_rate = 3e-4
max_train_steps = 10000

# æ¨¡å‹è·¯å¾„
pretrained_model_path = "checkpoints/taecvx.pth"
cogvideox_model_path = "CogVideoX-2b"

# è®­ç»ƒçŠ¶æ€
resume_from_checkpoint = "output/2025-09-29_22-24-51/checkpoint-5500"
# è¡¨ç¤ºï¼šå·²è®­ç»ƒ5500æ­¥ï¼Œä»æ­¤å¤„ç»§ç»­
```

### æ•°æ®é›†é…ç½®
```python
data_root = "/data/matrix-project/MiniDataset/data"
annotation_file = "/data/matrix-project/MiniDataset/stage1_annotations_500.json"
height = 128
width = 128
n_frames = 12
```

## ğŸ”§ æ¨ç†ç³»ç»Ÿ

### æ¨ç†è„šæœ¬åŠŸèƒ½ âœ…
- **æ–‡ä»¶**ï¼š`inference.py`
- **åŠŸèƒ½**ï¼š
  - æ¨¡å‹è´¨é‡è¯„ä¼°ï¼ˆMSE, PSNRï¼‰
  - è§†é¢‘é‡å»ºå¯è§†åŒ–
  - å‚è€ƒVAEå¯¹æ¯”æµ‹è¯•
  - å¤šæ ·æœ¬æ‰¹é‡æµ‹è¯•

### ä½¿ç”¨æ–¹å¼
```bash
# åŸºç¡€æ¨ç†
python inference.py \
    --model_path output/2025-09-29_22-24-51/final_model.pth \
    --num_samples 10

# å¸¦å‚è€ƒVAEå¯¹æ¯”
python inference.py \
    --model_path output/2025-09-29_22-24-51/final_model.pth \
    --use_ref_vae \
    --cogvideox_model_path CogVideoX-2b
```

## ğŸ“š æ–‡æ¡£å®Œå–„

### æ–‡æ¡£ç»“æ„
```
docs/
â”œâ”€â”€ æ¨¡å—è¯´æ˜.md           # Seraenaç»„ä»¶è¯´æ˜
â””â”€â”€ 9æœˆ29æ—¥è¿›å±•.md        # æœ¬æ–‡æ¡£
```

### READMEæ›´æ–° âœ…
- ç¯å¢ƒè®¾ç½®æŒ‡å—ï¼ˆconda + pipï¼‰
- é…ç½®å‚æ•°è¯´æ˜
- è®­ç»ƒå¯åŠ¨æ­¥éª¤
- æ¨ç†æµ‹è¯•æ–¹æ³•
- é«˜çº§ç”¨æ³•è¯´æ˜

## âš ï¸ å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 1. NCCLé€šä¿¡è¶…æ—¶
- **é—®é¢˜**ï¼šå¤šGPUè®­ç»ƒæ—¶é€šä¿¡è¶…æ—¶
- **è§£å†³**ï¼šé™ä½batch size (4â†’2)ï¼Œå¢åŠ gradient accumulation (1â†’2)
- **æ•ˆæœ**ï¼šç»´æŒè®­ç»ƒæ•ˆç‡ï¼Œé¿å…é€šä¿¡é—®é¢˜

### 2. condaç¯å¢ƒä¾èµ–å†²çª
- **é—®é¢˜**ï¼šopencv-python pip/condaå†²çª
- **è§£å†³**ï¼šä½¿ç”¨condaå®‰è£…opencvï¼Œä»pipä¾èµ–ä¸­ç§»é™¤
- **çŠ¶æ€**ï¼šå·²è§£å†³ âœ…

### 3. æ£€æŸ¥ç‚¹å…¼å®¹æ€§
- **é—®é¢˜**ï¼šDeepSpeedæ£€æŸ¥ç‚¹æ ¼å¼å¤æ‚
- **è§£å†³**ï¼šæ·»åŠ æ¨¡å‹çŠ¶æ€å•ç‹¬ä¿å­˜hooks
- **çŠ¶æ€**ï¼šå·²å®ç° âœ…

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸç›®æ ‡ï¼ˆæœ¬å‘¨ï¼‰
1. **è®­ç»ƒå®Œæˆ**ï¼šå®Œæˆ10000æ­¥è®­ç»ƒï¼ˆå½“å‰ï¼š5500/10000ï¼‰
2. **è´¨é‡è¯„ä¼°**ï¼šä½¿ç”¨inference.pyè¿›è¡Œå…¨é¢æµ‹è¯•
3. **æ€§èƒ½åˆ†æ**ï¼šå¯¹æ¯”æœ‰/æ— Seraenaçš„æ•ˆæœå·®å¼‚

### ä¸­æœŸç›®æ ‡ï¼ˆä¸‹å‘¨ï¼‰
1. **è¶…å‚æ•°ä¼˜åŒ–**ï¼šåŸºäºè®­ç»ƒç»“æœè°ƒæ•´å­¦ä¹ ç‡ç­‰å‚æ•°
2. **æ•°æ®æ‰©å……**ï¼šè€ƒè™‘å¢åŠ æ•°æ®å¢å¼ºç­–ç•¥
3. **å¤šå°ºåº¦è®­ç»ƒ**ï¼šæ”¯æŒä¸åŒåˆ†è¾¨ç‡çš„è®­ç»ƒ

### é•¿æœŸç›®æ ‡ï¼ˆæœ¬æœˆï¼‰
1. **æ¨¡å‹å‹ç¼©**ï¼šæ¢ç´¢é‡åŒ–å’Œå‰ªææŠ€æœ¯
2. **æ¨ç†ä¼˜åŒ–**ï¼šæå‡è§£ç é€Ÿåº¦
3. **åº”ç”¨é›†æˆ**ï¼šä¸å®é™…ä¸šåŠ¡æµç¨‹å¯¹æ¥

## ğŸ’» ç¯å¢ƒé…ç½®

### å·²éªŒè¯ç¯å¢ƒ
```yaml
# condaç¯å¢ƒï¼štiny-vae
python: 3.10+
torch: 2.0+
accelerate: 0.20+
deepspeed: 0.9+
diffusers: 0.21+
```

### ç¡¬ä»¶è¦æ±‚
- **GPU**ï¼š8x NVIDIA GPUï¼ˆæ”¯æŒbfloat16ï¼‰
- **å†…å­˜**ï¼šæ¯å¡è‡³å°‘24GBæ˜¾å­˜
- **å­˜å‚¨**ï¼š~50GBï¼ˆåŒ…å«æ¨¡å‹ã€æ•°æ®ã€è¾“å‡ºï¼‰

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### è®­ç»ƒæ•ˆç‡
- **æ¯æ­¥è€—æ—¶**ï¼š~2-3ç§’ï¼ˆ8å¡å¹¶è¡Œï¼‰
- **å†…å­˜å ç”¨**ï¼š~18GB/å¡ï¼ˆbatch_size=2ï¼‰
- **é€šä¿¡å¼€é”€**ï¼š<10%ï¼ˆDeepSpeedä¼˜åŒ–ï¼‰

### æ¨¡å‹è´¨é‡ï¼ˆæˆªè‡³checkpoint-5500ï¼‰
- **é‡å»ºæŸå¤±**ï¼šæ­£å¸¸ä¸‹é™è¶‹åŠ¿
- **ç¼–ç æŸå¤±**ï¼šå‚è€ƒVAEæŒ‡å¯¼æœ‰æ•ˆ
- **æ¢¯åº¦èŒƒæ•°**ï¼šç¨³å®šåœ¨åˆç†èŒƒå›´

## ğŸ”— å…³é”®æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒæ–‡ä»¶
- `training/configs/taehv_config.py` - ç»Ÿä¸€é…ç½®
- `training/taehv_train.py` - è®­ç»ƒä¸»è„šæœ¬  
- `models/taehv.py` - æ¨¡å‹å®šä¹‰
- `models/seraena.py` - å¯¹æŠ—è®­ç»ƒå™¨
- `inference.py` - æ¨ç†æµ‹è¯•
- `train_taehv.sh` - å¯åŠ¨è„šæœ¬

### é…ç½®æ–‡ä»¶
- `accelerate_configs/deepspeed.yaml` - DeepSpeedé…ç½®
- `environment.yml` - condaç¯å¢ƒ
- `requirements.txt` - pipä¾èµ–

### æ£€æŸ¥ç‚¹
- `checkpoints/taecvx.pth` - é¢„è®­ç»ƒæ¨¡å‹
- `output/2025-09-29_22-24-51/checkpoint-5500` - å½“å‰æ£€æŸ¥ç‚¹

## âœ… å®ŒæˆçŠ¶æ€æ€»ç»“

| ä»»åŠ¡é¡¹ | çŠ¶æ€ | å®Œæˆåº¦ |
|--------|------|--------|
| é¡¹ç›®ç»“æ„é‡ç»„ | âœ… | 100% |
| é…ç½®å‚æ•°åŒ– | âœ… | 100% |  
| DeepSpeedé›†æˆ | âœ… | 100% |
| å®¹é”™æœºåˆ¶ | âœ… | 100% |
| Seraenaé›†æˆ | âœ… | 100% |
| æ¨ç†ç³»ç»Ÿ | âœ… | 100% |
| æ–‡æ¡£å®Œå–„ | âœ… | 100% |
| æ¨¡å‹è®­ç»ƒ | ğŸ”„ | 55% (5500/10000æ­¥) |

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2025å¹´9æœˆ30æ—¥  
**é¡¹ç›®çŠ¶æ€**ï¼šè®­ç»ƒè¿›è¡Œä¸­ï¼Œæ‰€æœ‰åŸºç¡€è®¾æ–½å°±ç»ª  
**ä¸‹æ¬¡æ›´æ–°**ï¼šè®­ç»ƒå®Œæˆåæˆ–é‡åˆ°é‡å¤§è¿›å±•æ—¶

