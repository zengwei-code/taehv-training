# Tiny-VAE 训练完整指南

**最后更新**: 2025-10-12

---

## 📋 目录

1. [快速开始](#快速开始)
2. [配置问题诊断与修复](#配置问题诊断与修复)
3. [A800测试到H100迁移](#a800测试到h100迁移)
4. [监控与验证](#监控与验证)

---

## 🚀 快速开始

### 在8*A800上测试（2-4小时）

```bash
# 1. 进入项目并激活环境
cd /data/matrix-project/seraena/my_taehv_training
conda activate tiny-vae

# 2. 启动A800测试（5000步）
bash train_taehv_h100.sh 8 custom training/configs/taehv_config_a800_fixed.py

# 3. 监控（另开终端）
tensorboard --logdir logs --port 6006
```

**等待1000步后检查PSNR**：
- ✅ PSNR > 25 dB: 测试成功，可迁移H100
- ⚠️ PSNR < 25 dB: 需要检查日志

### 在8*H100上生产训练（1-2天）

```bash
# 1. 进入项目并激活环境
cd /data/matrix-project/seraena/my_taehv_training
conda activate tiny-vae

# 2. 启动H100生产训练（100000步）
bash train_taehv_h100.sh 8 custom training/configs/taehv_config_h100_fixed.py

# 3. 后台运行（推荐）
nohup bash train_taehv_h100.sh 8 custom training/configs/taehv_config_h100_fixed.py > h100_train.log 2>&1 &

# 4. 监控
tensorboard --logdir logs --port 6006
tail -f h100_train.log
```

---

## 🔍 配置问题诊断与修复

### PSNR只有4.2的根本原因

**问题配置**（原始 `taehv_config_h100.py`）：
```python
args.encoder_loss_weight = 1.0          # ❌ 太高
args.decoder_loss_weight = 1.0          # ❌ 太高
args.reconstruction_loss_weight = 0.1   # ❌ 太低！
args.seraena_loss_weight = 0.3
```

**修复后配置**（`taehv_config_h100_fixed.py`）：
```python
args.reconstruction_loss_weight = 10.0  # ✅ 提高100倍
args.encoder_loss_weight = 0.1         # ✅ 降低
args.decoder_loss_weight = 0.1         # ✅ 降低
args.perceptual_loss_weight = 0.1      # ✅ 提高
args.seraena_loss_weight = 0.1         # ✅ 降低
```

### 关键修复点

| 参数 | 原配置 | 修复后 | 影响 |
|------|--------|--------|------|
| **reconstruction_loss_weight** | 0.1 | **10.0** | ⭐ 最关键 |
| **encoder_loss_weight** | 1.0 | **0.1** | 重要 |
| **decoder_loss_weight** | 1.0 | **0.1** | 重要 |
| **learning_rate** | 5e-5 | **1e-4** | 提高训练速度 |
| **early_stopping_patience** | 10000 | **5** | 实际可用 |
| **metric_for_best_model** | reconstruction_loss | **psnr** | 正确指标 |
| **num_validation_samples** | 10 | **20** | 更准确 |
| **validation_batch_size** | 4 | **2** | 避免OOM |

### 预期效果

| 步数 | 修复前PSNR | 修复后PSNR | 改善 |
|-----|-----------|-----------|------|
| 1000步 | **4.2 dB** | **25-28 dB** | **+20dB** |
| 最终 | <10 dB | **28-32 dB** | **+20dB** |

---

## 🔄 A800测试到H100迁移

### 配置对比

| 配置项 | A800测试 | H100生产 | 说明 |
|--------|---------|---------|------|
| **配置文件** | `taehv_config_a800_fixed.py` | `taehv_config_h100_fixed.py` | 已修复 |
| **数据集** | 生产数据集 | 生产数据集 | ✅ 相同 |
| **分辨率** | 720×480×12 | 720×480×12 | ✅ 相同 |
| **batch_size** | 2 | 2 | ✅ 相同 |
| **gradient_accumulation** | 8 | 8 | ✅ 相同 |
| **learning_rate** | 1e-4 | 1e-4 | ✅ 相同 |
| **reconstruction_loss_weight** | 10.0 | 10.0 | ✅ 相同 |
| **训练步数** | 5000 | 100000 | A800快速测试 |
| **输出目录** | `output/a800_test_*` | `output/*` | 便于区分 |

**核心训练参数完全相同**，A800测试通过后可无缝迁移到H100。

### 迁移步骤

#### 第一步：A800测试

```bash
# 检查环境
cd /data/matrix-project/seraena/my_taehv_training
conda activate tiny-vae
nvidia-smi  # 确认8张A800

# 启动测试
bash train_taehv_h100.sh 8 custom training/configs/taehv_config_a800_fixed.py

# 监控
tensorboard --logdir logs --port 6006
```

**验证成功标准**：
- Step 1000: PSNR > 25 dB
- GPU利用率 > 80%
- 训练loss持续下降
- 最佳模型已保存

#### 第二步：H100迁移

```bash
# 登录H100服务器（如果是不同机器）
# ssh your_h100_server

cd /data/matrix-project/seraena/my_taehv_training
conda activate tiny-vae
nvidia-smi  # 确认8张H100

# 启动生产训练
bash train_taehv_h100.sh 8 custom training/configs/taehv_config_h100_fixed.py

# 后台运行
nohup bash train_taehv_h100.sh 8 custom training/configs/taehv_config_h100_fixed.py > h100_train.log 2>&1 &
```

### 从A800恢复到H100

```bash
# 1. 复制A800的checkpoint
scp -r a800_server:/path/to/output/a800_test_*/checkpoint-3000 ./checkpoints/

# 2. 在H100上恢复训练
bash train_taehv_h100.sh 8 custom training/configs/taehv_config_h100_fixed.py --resume checkpoints/checkpoint-3000
```

---

## 📊 监控与验证

### 实时监控

```bash
# 终端1: TensorBoard
tensorboard --logdir logs --port 6006

# 终端2: GPU监控
watch -n 1 nvidia-smi

# 终端3: 训练日志
tail -f logs/taehv_*/train.log
```

### 验证指标检查

```bash
# 查看最佳模型信息
cat output/*/best_model/model_info.json

# 查看验证历史
cat output/*/validation_history.json

# 查看最新输出
ls -lt output/
```

### 预期训练曲线

| 步数 | PSNR | SSIM | LPIPS | 状态 |
|-----|------|------|-------|------|
| 100 | 18-22 dB | 0.70-0.80 | 0.15-0.25 | 开始学习 |
| 1000 | 25-28 dB | 0.85-0.90 | 0.10-0.15 | 正常训练 |
| 5000 | 27-30 dB | 0.88-0.92 | 0.08-0.12 | 良好 |
| 10000 | 28-31 dB | 0.90-0.94 | 0.06-0.10 | 优秀 |
| 50000+ | 29-32 dB | 0.92-0.95 | 0.05-0.08 | 收敛 |

### 验证系统特性

- **自动验证**: 每1000步自动运行
- **指标计算**: PSNR, SSIM, LPIPS
- **最佳模型保存**: 自动保存到 `output/*/best_model/`
- **早停机制**: 5次验证无改善自动停止
- **验证历史**: 保存到 `validation_history.json`

---

## 🔍 故障排查

### PSNR仍然很低（<15 dB）

```bash
# 1. 确认使用了修复后的配置
cat training/configs/taehv_config_a800_fixed.py | grep reconstruction_loss_weight
# 应该看到: args.reconstruction_loss_weight = 10.0

# 2. 查看训练loss
tensorboard --logdir logs
# 检查 train/reconstruction_loss 是否下降

# 3. 查看数据加载日志
grep "Loaded.*training samples" logs/*/train.log
```

### OOM (Out of Memory)

```bash
# 修改配置文件
args.train_batch_size = 1          # 降低batch size
args.gradient_accumulation_steps = 16  # 提高accumulation
args.validation_batch_size = 1     # 降低验证batch size
```

### H100和A800结果差异大

**正常差异**：
- H100可能稍快（5-10%）
- PSNR应该非常接近（±0.5 dB）

**如果差异>2 dB**：
- 检查随机种子是否相同
- 检查数据集是否相同
- 检查配置文件是否相同

---

## 📁 相关文件

### 配置文件
- ✅ `training/configs/taehv_config_a800_fixed.py` - A800测试配置（已修复）
- ✅ `training/configs/taehv_config_h100_fixed.py` - H100生产配置（已修复）
- ⚠️ `training/configs/taehv_config_a800.py` - 旧配置（不推荐）
- ⚠️ `training/configs/taehv_config_h100.py` - 旧配置（不推荐）

### 启动脚本
- `train_taehv_h100.sh` - 统一启动脚本（支持A800/H100切换）
- `train_taehv.sh` - 通用训练脚本

### DeepSpeed配置
- `accelerate_configs/deepspeed_8gpu.yaml` - 8卡DeepSpeed配置

---

## ✅ 检查清单

### A800测试前
- [ ] conda环境激活
- [ ] 检查GPU: 8张A800
- [ ] 数据集路径存在
- [ ] 使用修复后的配置: `taehv_config_a800_fixed.py`
- [ ] loss权重已修复: `reconstruction_loss_weight = 10.0`

### A800测试后
- [ ] Step 1000 PSNR > 25 dB
- [ ] 最佳模型已保存
- [ ] 验证曲线平滑
- [ ] 无OOM或其他错误

### H100迁移
- [ ] A800测试通过
- [ ] H100环境准备好
- [ ] 使用修复后的配置: `taehv_config_h100_fixed.py`
- [ ] 启动H100训练
- [ ] 监控验证指标

---

## 🎯 重要提醒

### ✅ 使用这些配置（已修复）
- `training/configs/taehv_config_a800_fixed.py`
- `training/configs/taehv_config_h100_fixed.py`

### ❌ 不要使用这些配置（未修复）
- `training/configs/taehv_config_a800.py`
- `training/configs/taehv_config_h100.py`

### 🔑 核心修复
1. **reconstruction_loss_weight = 10.0** （最关键！）
2. **early_stopping_patience = 5**
3. **metric_for_best_model = "psnr"**
4. **learning_rate = 1e-4**

---

**预期时间**：
- A800测试（5000步）: 2-4小时
- H100训练（100000步）: 1-2天

**成功标志**：
- A800测试PSNR > 25 dB
- H100训练PSNR > 28 dB
- 最佳模型自动保存

