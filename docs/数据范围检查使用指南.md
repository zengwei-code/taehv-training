# 数据范围检查功能使用指南

**功能**: 诊断训练中的数据范围问题，特别是当PSNR异常低时  
**创建时间**: 2025-10-13

---

## 📋 功能概述

数据范围检查功能自动检测并报告训练和验证过程中的数据范围异常，帮助快速定位PSNR低的根本原因。

### 三种检查模式

1. **训练开始时自动检查**（详细）
2. **验证时定期检查**（简化）
3. **独立脚本事后检查**（灵活）

---

## 🚀 快速开始

### 模式1：训练时自动检查

**无需额外配置**，正常启动训练即可：

```bash
cd /data/matrix-project/seraena/my_taehv_training
bash train_taehv_h100.sh 8 custom training/configs/taehv_config_a800.py
```

**输出示例**（训练开始时）：

```
===============================================================================
🔍 Performing initial data range and configuration check...
===============================================================================

⚙️  Model Configuration Check
===============================================================================

📂 Data Configuration:
  height: 480
  width: 720
  n_frames: 12
  batch_size: 8
  augmentation: True

🏗️  Model Configuration:
  model_type: TAEHV
  use_seraena: False

🎯 Training Configuration:
  learning_rate: 0.0001
  lr_scheduler: cosine
  max_train_steps: 2000
  gradient_accumulation_steps: 8

⚖️  Loss Weights Configuration:
  reconstruction_loss_weight: 10.0
  encoder_loss_weight: 0.1
  decoder_loss_weight: 0.1

===============================================================================

Checking first batch of training data...

===============================================================================
🔍 Data Range Check (Step 0, initial_train)
===============================================================================

📥 Input Videos:
  Shape: [2, 12, 3, 480, 720]
  Range: [0.0123, 0.9877]  (Expected: [0, 1])
  Mean: 0.4521 ± 0.2134
  Median: 0.4512
  Dtype: torch.float32

📤 Reconstructions:
  Shape: [2, 9, 3, 480, 720]
  Range: [0.0089, 0.9932]
  Mean: 0.4498 ± 0.2156
  Median: 0.4489
  Dtype: torch.float32

📊 Reconstruction Errors:
  MSE:  0.023456
  RMSE: 0.153166
  MAE:  0.124532
  Max Diff: 0.345678

🎨 Per-Channel Analysis:
  R:
    Input:  Mean=0.4523, Std=0.2145
    Recon:  Mean=0.4498, Std=0.2156
    Diff:   Mean=0.0025, Std=0.0231
  G:
    Input:  Mean=0.4519, Std=0.2128
    Recon:  Mean=0.4495, Std=0.2149
    Diff:   Mean=0.0024, Std=0.0229
  B:
    Input:  Mean=0.4521, Std=0.2129
    Recon:  Mean=0.4499, Std=0.2163
    Diff:   Mean=0.0022, Std=0.0227

✅ No warnings - Data ranges look correct!
===============================================================================

💾 Saved data range check to output/.../data_range_check_initial.json
Initial check completed. Starting training...
```

### 检查频率

- **训练开始时**: 详细检查（打印所有信息）
- **验证时**: 每5次验证或第一次验证时检查
  - Step 1000 ✅（第一次验证）
  - Step 5000 ✅（第5次验证）
  - Step 10000 ✅（第10次验证）

---

## 🔍 模式2：验证时自动检查

验证时的检查会在以下情况触发：

```python
if global_step % (config.validation_steps * 5) == 0 or global_step == config.validation_steps:
    # 执行数据范围检查
```

**输出示例**（验证时）：

```
🔍 Running validation at step 1000
Computing validation metrics on 20 samples...
✅ Validation Results (Step 1000):
   PSNR:  10.01 ± 1.52 dB
   SSIM:  0.1923

🔍 Performing data range check during validation...

===============================================================================
🔍 Data Range Check (Step 1000, val)
===============================================================================

📥 Input Videos:
  Range: [0.0098, 0.9912]  (Expected: [0, 1])
  Mean: 0.4534 ± 0.2145

📤 Reconstructions:
  Range: [0.0076, 0.9945]
  Mean: 0.4512 ± 0.2167

📊 Reconstruction Errors:
  MSE:  0.021234
  MAE:  0.118765

✅ No warnings - Data ranges look correct!
===============================================================================

💾 Saved data range check to output/.../data_range_check_step1000.json
```

---

## 🛠️ 模式3：独立脚本检查

### 使用场景

- 训练已经完成，想事后分析
- 怀疑某个checkpoint有问题
- 需要详细检查多个样本

### 基本用法

```bash
cd /data/matrix-project/seraena/my_taehv_training

python scripts/check_model_data_range.py \
    --model_path output/a800_test_2025-10-13_11-20-15/checkpoint-2000/model.pth \
    --config training/configs/taehv_config_a800.py \
    --output_dir ./check_results
```

### 完整参数

```bash
python scripts/check_model_data_range.py \
    --model_path output/xxx/checkpoint-1000/model.pth \
    --config training/configs/taehv_config_a800.py \
    --data_root /path/to/data \
    --annotation_file /path/to/annotations.json \
    --output_dir ./check_results \
    --num_samples 10 \
    --batch_size 2 \
    --device cuda:0
```

### 参数说明

| 参数 | 必需 | 说明 |
|-----|------|------|
| `--model_path` | ✅ | 模型checkpoint路径 |
| `--config` | ✅ | 配置文件路径 |
| `--data_root` | ❌ | 数据目录（覆盖config） |
| `--annotation_file` | ❌ | 标注文件（覆盖config） |
| `--output_dir` | ❌ | 输出目录（默认: `./check_results`） |
| `--num_samples` | ❌ | 检查样本数（默认: 5） |
| `--batch_size` | ❌ | 批次大小（默认: 2） |
| `--device` | ❌ | 设备（默认: `cuda:0`） |

### 输出文件

独立脚本会生成以下文件：

```
check_results/
├── batch_0_result.json       # 第1个batch的详细结果
├── batch_1_result.json       # 第2个batch的详细结果
├── ...
├── summary.json              # 汇总统计
└── full_check_history.json   # 完整历史记录
```

**summary.json示例**：

```json
{
  "num_batches": 5,
  "total_warnings": 2,
  "high_severity_warnings": 1,
  "avg_input_range": 0.9765,
  "avg_recon_range": 0.9821,
  "avg_mse": 0.023456,
  "avg_mae": 0.124532,
  "estimated_psnr": 16.3
}
```

---

## ⚠️ 警告类型和解决方案

### 1. Input Range Abnormal（输入范围异常）

**错误信息**：
```
🔴 [input_range_abnormal] Input range [0.5000, 1.0000] out of expected [0, 1]
```

**原因**：输入数据范围不在`[0, 1]`

**解决方案**：
```python
# 检查MiniDataset的数据预处理
# training/data/minidataset.py
frames = frames / 255.0  # 确保归一化到[0, 1]

# 或检查训练脚本
frames = batch.float() / 255.0  # 确保除以255
```

### 2. Recon Range Abnormal（重建范围异常）

**错误信息**：
```
🔴 [recon_range_abnormal] Reconstruction range [-0.1234, 1.2345] is unusual
```

**原因**：模型输出超出了正常范围

**解决方案**：
1. 检查模型decoder的激活函数
2. 检查是否需要clamp：`reconstructions = reconstructions.clamp(0, 1)`
3. 可能是模型训练不稳定

### 3. Range Mismatch（范围不匹配）

**错误信息**：
```
🟡 [range_mismatch] Input range (0.98) differs from recon range (0.65)
```

**原因**：重建范围比输入范围窄，说明对比度丢失

**解决方案**：
1. 提高`reconstruction_loss_weight`
2. 检查decoder是否有问题
3. 检查激活函数（如使用sigmoid，可能压缩范围）

### 4. High MSE（高重建误差）

**错误信息**：
```
🔴 [high_mse] High MSE (0.1234) indicates poor reconstruction
```

**原因**：重建质量差，这直接导致PSNR低

**解决方案**：
1. 提高`reconstruction_loss_weight`（从10.0到50.0）
2. 降低其他loss权重
3. 检查学习率是否合适
4. 增加训练步数

### 5. Narrow Recon Range（重建范围过窄）

**错误信息**：
```
🔴 [narrow_recon_range] Reconstruction range (0.45) too narrow (input: 0.98)
```

**原因**：模型输出范围太窄，丢失了细节

**解决方案**：
1. 检查decoder的最后一层激活函数
2. 如果使用sigmoid，考虑移除或改用其他激活
3. 检查normalization层

---

## 📊 TensorBoard可视化

数据范围信息会自动记录到TensorBoard：

### 查看方式

```bash
tensorboard --logdir=logs/
```

### 可用指标

**训练指标**：
- `train/debug/input_min`
- `train/debug/input_max`
- `train/debug/input_mean`
- `train/debug/input_range`
- `train/debug/recon_min`
- `train/debug/recon_max`
- `train/debug/recon_mean`
- `train/debug/recon_range`
- `train/debug/mse`
- `train/debug/mae`

**验证指标**：
- `val/debug/input_min`
- `val/debug/input_max`
- `val/debug/input_range`
- `val/debug/recon_min`
- `val/debug/recon_max`
- `val/debug/recon_range`
- `val/debug/mse`
- `val/debug/mae`
- `val/debug/num_warnings`

### 分析技巧

1. **观察趋势**：
   - `input_range`应该稳定在0.95-1.0附近
   - `recon_range`应该与`input_range`接近

2. **对比输入和重建**：
   - 如果`recon_range`一直小于`input_range` → 对比度丢失
   - 如果`recon_mean`偏离`input_mean` → 亮度偏移

3. **监控MSE**：
   - MSE < 0.01 → 重建很好（PSNR > 40 dB）
   - MSE ~ 0.05 → 重建一般（PSNR ~ 25-30 dB）
   - MSE > 0.1 → 重建很差（PSNR < 20 dB）

---

## 🎯 实际案例分析

### 案例1：PSNR只有7 dB的问题

**初始检查结果**：
```
Input range: [0.0123, 0.9877]  ✅ 正常
Recon range: [0.4123, 0.5877]  ❌ 范围太窄！
MSE: 0.15  ❌ 很高！

⚠️  [narrow_recon_range] Reconstruction range (0.18) too narrow (input: 0.98)
⚠️  [high_mse] High MSE (0.1500) indicates poor reconstruction
```

**问题诊断**：
- 重建范围只有0.18，输入范围是0.98
- 说明decoder输出被压缩了
- 可能是sigmoid激活函数的问题

**解决方案**：
```python
# 检查decoder最后一层
# 如果是: output = torch.sigmoid(x)
# 改为: output = x.clamp(0, 1)  或移除激活函数
```

### 案例2：输入数据范围错误

**初始检查结果**：
```
Input range: [-0.9877, 0.9877]  ❌ 不是[0,1]！
Recon range: [0.0089, 0.9932]   ✅ 正常

⚠️  [input_range_abnormal] Input range [-0.99, 0.99] out of expected [0, 1]
⚠️  [range_mismatch] Input range (1.97) differs from recon range (0.98)
```

**问题诊断**：
- 输入是`[-1, 1]`范围，但模型期望`[0, 1]`
- 数据加载或预处理有问题

**解决方案**：
```python
# 训练脚本中
frames = batch.float() / 255.0  # [0, 1]
# 如果数据已经是[-1, 1]，需要转换
if frames.min() < 0:
    frames = (frames + 1) / 2  # [-1, 1] → [0, 1]
```

---

## 💡 最佳实践

### 1. 训练前检查

```bash
# 启动训练前，查看初始检查结果
bash train_taehv_h100.sh 8 custom training/configs/taehv_config_a800.py

# 如果发现高严重性警告，立即停止（Ctrl+C）
# 修复问题后重新启动
```

### 2. 定期监控

```bash
# 在TensorBoard中监控数据范围
tensorboard --logdir=logs/

# 关注：
# - debug/input_range 是否稳定
# - debug/recon_range 是否接近input_range
# - debug/mse 是否下降
```

### 3. 出现问题时

```bash
# 使用独立脚本详细检查
python scripts/check_model_data_range.py \
    --model_path output/xxx/checkpoint-2000/model.pth \
    --config training/configs/taehv_config_a800.py \
    --num_samples 10 \
    --output_dir ./diagnostic_check

# 查看汇总
cat ./diagnostic_check/summary.json

# 查看详细结果
cat ./diagnostic_check/batch_0_result.json
```

---

## 🔧 故障排除

### Q1: 检查脚本报错找不到数据

**错误**：
```
❌ Failed to load dataset: FileNotFoundError
```

**解决**：
```bash
# 方法1：指定正确的数据路径
python scripts/check_model_data_range.py \
    --model_path xxx/model.pth \
    --config xxx/config.py \
    --data_root /correct/path/to/data \
    --annotation_file /correct/path/to/annotations.json

# 方法2：创建小的测试数据集
# 只需要几个视频样本用于检查
```

### Q2: 初始检查失败

**错误**：
```
❌ Initial data check failed: CUDA out of memory
```

**解决**：
```python
# 修改检查时使用的样本数
# training/taehv_train.py 第593行
encoded_check = model.encode_video(frames_check[:1], ...)  # 从:2改为:1
```

### Q3: 检查结果都是warning

**情况**：所有batch都有高严重性警告

**解决**：
1. 这说明存在系统性问题
2. 重点检查数据加载和模型配置
3. 考虑从头开始训练

---

## 📚 相关文档

- `docs/INFERENCE_AND_EVALUATION_GUIDE.md` - 推理与评估流程
- `docs/TROUBLESHOOTING.md` - 故障排除
- `training/utils/data_range_checker.py` - 实现代码
- `scripts/check_model_data_range.py` - 独立检查脚本

---

**总结**：数据范围检查功能能够自动检测训练中的数据问题，是诊断PSNR低的关键工具。建议在训练开始时就关注检查结果，及时发现并解决问题。

