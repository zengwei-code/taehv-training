# æ•°æ®èŒƒå›´æ£€æŸ¥åŠŸèƒ½ä½¿ç”¨æŒ‡å—

**åŠŸèƒ½**: è¯Šæ–­è®­ç»ƒä¸­çš„æ•°æ®èŒƒå›´é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯å½“PSNRå¼‚å¸¸ä½æ—¶  
**åˆ›å»ºæ—¶é—´**: 2025-10-13

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æ•°æ®èŒƒå›´æ£€æŸ¥åŠŸèƒ½è‡ªåŠ¨æ£€æµ‹å¹¶æŠ¥å‘Šè®­ç»ƒå’ŒéªŒè¯è¿‡ç¨‹ä¸­çš„æ•°æ®èŒƒå›´å¼‚å¸¸ï¼Œå¸®åŠ©å¿«é€Ÿå®šä½PSNRä½çš„æ ¹æœ¬åŸå› ã€‚

### ä¸‰ç§æ£€æŸ¥æ¨¡å¼

1. **è®­ç»ƒå¼€å§‹æ—¶è‡ªåŠ¨æ£€æŸ¥**ï¼ˆè¯¦ç»†ï¼‰
2. **éªŒè¯æ—¶å®šæœŸæ£€æŸ¥**ï¼ˆç®€åŒ–ï¼‰
3. **ç‹¬ç«‹è„šæœ¬äº‹åæ£€æŸ¥**ï¼ˆçµæ´»ï¼‰

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ¨¡å¼1ï¼šè®­ç»ƒæ—¶è‡ªåŠ¨æ£€æŸ¥

**æ— éœ€é¢å¤–é…ç½®**ï¼Œæ­£å¸¸å¯åŠ¨è®­ç»ƒå³å¯ï¼š

```bash
cd /data/matrix-project/seraena/my_taehv_training
bash train_taehv_h100.sh 8 custom training/configs/taehv_config_a800.py
```

**è¾“å‡ºç¤ºä¾‹**ï¼ˆè®­ç»ƒå¼€å§‹æ—¶ï¼‰ï¼š

```
===============================================================================
ğŸ” Performing initial data range and configuration check...
===============================================================================

âš™ï¸  Model Configuration Check
===============================================================================

ğŸ“‚ Data Configuration:
  height: 480
  width: 720
  n_frames: 12
  batch_size: 8
  augmentation: True

ğŸ—ï¸  Model Configuration:
  model_type: TAEHV
  use_seraena: False

ğŸ¯ Training Configuration:
  learning_rate: 0.0001
  lr_scheduler: cosine
  max_train_steps: 2000
  gradient_accumulation_steps: 8

âš–ï¸  Loss Weights Configuration:
  reconstruction_loss_weight: 10.0
  encoder_loss_weight: 0.1
  decoder_loss_weight: 0.1

===============================================================================

Checking first batch of training data...

===============================================================================
ğŸ” Data Range Check (Step 0, initial_train)
===============================================================================

ğŸ“¥ Input Videos:
  Shape: [2, 12, 3, 480, 720]
  Range: [0.0123, 0.9877]  (Expected: [0, 1])
  Mean: 0.4521 Â± 0.2134
  Median: 0.4512
  Dtype: torch.float32

ğŸ“¤ Reconstructions:
  Shape: [2, 9, 3, 480, 720]
  Range: [0.0089, 0.9932]
  Mean: 0.4498 Â± 0.2156
  Median: 0.4489
  Dtype: torch.float32

ğŸ“Š Reconstruction Errors:
  MSE:  0.023456
  RMSE: 0.153166
  MAE:  0.124532
  Max Diff: 0.345678

ğŸ¨ Per-Channel Analysis:
  R:
    Input:  Mean=0.4523, Std=0.2145
    Recon:  Mean=0.4498, Std=0.2156
    Diff:   Mean=0.0025, Std=0.0231
  G:
    Input:  Mean=0.4519, Std=0.2128
    Recon:  Mean=0.4495, Std=0.2149
    Diff:   Mean=0.0024, Std=0.0229
  B:
    Input:  Mean=0.4521, Std=0.2129
    Recon:  Mean=0.4499, Std=0.2163
    Diff:   Mean=0.0022, Std=0.0227

âœ… No warnings - Data ranges look correct!
===============================================================================

ğŸ’¾ Saved data range check to output/.../data_range_check_initial.json
Initial check completed. Starting training...
```

### æ£€æŸ¥é¢‘ç‡

- **è®­ç»ƒå¼€å§‹æ—¶**: è¯¦ç»†æ£€æŸ¥ï¼ˆæ‰“å°æ‰€æœ‰ä¿¡æ¯ï¼‰
- **éªŒè¯æ—¶**: æ¯5æ¬¡éªŒè¯æˆ–ç¬¬ä¸€æ¬¡éªŒè¯æ—¶æ£€æŸ¥
  - Step 1000 âœ…ï¼ˆç¬¬ä¸€æ¬¡éªŒè¯ï¼‰
  - Step 5000 âœ…ï¼ˆç¬¬5æ¬¡éªŒè¯ï¼‰
  - Step 10000 âœ…ï¼ˆç¬¬10æ¬¡éªŒè¯ï¼‰

---

## ğŸ” æ¨¡å¼2ï¼šéªŒè¯æ—¶è‡ªåŠ¨æ£€æŸ¥

éªŒè¯æ—¶çš„æ£€æŸ¥ä¼šåœ¨ä»¥ä¸‹æƒ…å†µè§¦å‘ï¼š

```python
if global_step % (config.validation_steps * 5) == 0 or global_step == config.validation_steps:
    # æ‰§è¡Œæ•°æ®èŒƒå›´æ£€æŸ¥
```

**è¾“å‡ºç¤ºä¾‹**ï¼ˆéªŒè¯æ—¶ï¼‰ï¼š

```
ğŸ” Running validation at step 1000
Computing validation metrics on 20 samples...
âœ… Validation Results (Step 1000):
   PSNR:  10.01 Â± 1.52 dB
   SSIM:  0.1923

ğŸ” Performing data range check during validation...

===============================================================================
ğŸ” Data Range Check (Step 1000, val)
===============================================================================

ğŸ“¥ Input Videos:
  Range: [0.0098, 0.9912]  (Expected: [0, 1])
  Mean: 0.4534 Â± 0.2145

ğŸ“¤ Reconstructions:
  Range: [0.0076, 0.9945]
  Mean: 0.4512 Â± 0.2167

ğŸ“Š Reconstruction Errors:
  MSE:  0.021234
  MAE:  0.118765

âœ… No warnings - Data ranges look correct!
===============================================================================

ğŸ’¾ Saved data range check to output/.../data_range_check_step1000.json
```

---

## ğŸ› ï¸ æ¨¡å¼3ï¼šç‹¬ç«‹è„šæœ¬æ£€æŸ¥

### ä½¿ç”¨åœºæ™¯

- è®­ç»ƒå·²ç»å®Œæˆï¼Œæƒ³äº‹ååˆ†æ
- æ€€ç–‘æŸä¸ªcheckpointæœ‰é—®é¢˜
- éœ€è¦è¯¦ç»†æ£€æŸ¥å¤šä¸ªæ ·æœ¬

### åŸºæœ¬ç”¨æ³•

```bash
cd /data/matrix-project/seraena/my_taehv_training

python scripts/check_model_data_range.py \
    --model_path output/a800_test_2025-10-13_11-20-15/checkpoint-2000/model.pth \
    --config training/configs/taehv_config_a800.py \
    --output_dir ./check_results
```

### å®Œæ•´å‚æ•°

```bash
python scripts/check_model_data_range.py \
    --model_path output/xxx/checkpoint-1000/model.pth \
    --config training/configs/taehv_config_a800.py \
    --data_root /path/to/data \
    --annotation_file /path/to/annotations.json \
    --output_dir ./check_results \
    --num_samples 10 \
    --batch_size 2 \
    --device cuda:0
```

### å‚æ•°è¯´æ˜

| å‚æ•° | å¿…éœ€ | è¯´æ˜ |
|-----|------|------|
| `--model_path` | âœ… | æ¨¡å‹checkpointè·¯å¾„ |
| `--config` | âœ… | é…ç½®æ–‡ä»¶è·¯å¾„ |
| `--data_root` | âŒ | æ•°æ®ç›®å½•ï¼ˆè¦†ç›–configï¼‰ |
| `--annotation_file` | âŒ | æ ‡æ³¨æ–‡ä»¶ï¼ˆè¦†ç›–configï¼‰ |
| `--output_dir` | âŒ | è¾“å‡ºç›®å½•ï¼ˆé»˜è®¤: `./check_results`ï¼‰ |
| `--num_samples` | âŒ | æ£€æŸ¥æ ·æœ¬æ•°ï¼ˆé»˜è®¤: 5ï¼‰ |
| `--batch_size` | âŒ | æ‰¹æ¬¡å¤§å°ï¼ˆé»˜è®¤: 2ï¼‰ |
| `--device` | âŒ | è®¾å¤‡ï¼ˆé»˜è®¤: `cuda:0`ï¼‰ |

### è¾“å‡ºæ–‡ä»¶

ç‹¬ç«‹è„šæœ¬ä¼šç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

```
check_results/
â”œâ”€â”€ batch_0_result.json       # ç¬¬1ä¸ªbatchçš„è¯¦ç»†ç»“æœ
â”œâ”€â”€ batch_1_result.json       # ç¬¬2ä¸ªbatchçš„è¯¦ç»†ç»“æœ
â”œâ”€â”€ ...
â”œâ”€â”€ summary.json              # æ±‡æ€»ç»Ÿè®¡
â””â”€â”€ full_check_history.json   # å®Œæ•´å†å²è®°å½•
```

**summary.jsonç¤ºä¾‹**ï¼š

```json
{
  "num_batches": 5,
  "total_warnings": 2,
  "high_severity_warnings": 1,
  "avg_input_range": 0.9765,
  "avg_recon_range": 0.9821,
  "avg_mse": 0.023456,
  "avg_mae": 0.124532,
  "estimated_psnr": 16.3
}
```

---

## âš ï¸ è­¦å‘Šç±»å‹å’Œè§£å†³æ–¹æ¡ˆ

### 1. Input Range Abnormalï¼ˆè¾“å…¥èŒƒå›´å¼‚å¸¸ï¼‰

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ğŸ”´ [input_range_abnormal] Input range [0.5000, 1.0000] out of expected [0, 1]
```

**åŸå› **ï¼šè¾“å…¥æ•°æ®èŒƒå›´ä¸åœ¨`[0, 1]`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# æ£€æŸ¥MiniDatasetçš„æ•°æ®é¢„å¤„ç†
# training/data/minidataset.py
frames = frames / 255.0  # ç¡®ä¿å½’ä¸€åŒ–åˆ°[0, 1]

# æˆ–æ£€æŸ¥è®­ç»ƒè„šæœ¬
frames = batch.float() / 255.0  # ç¡®ä¿é™¤ä»¥255
```

### 2. Recon Range Abnormalï¼ˆé‡å»ºèŒƒå›´å¼‚å¸¸ï¼‰

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ğŸ”´ [recon_range_abnormal] Reconstruction range [-0.1234, 1.2345] is unusual
```

**åŸå› **ï¼šæ¨¡å‹è¾“å‡ºè¶…å‡ºäº†æ­£å¸¸èŒƒå›´

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æ¨¡å‹decoderçš„æ¿€æ´»å‡½æ•°
2. æ£€æŸ¥æ˜¯å¦éœ€è¦clampï¼š`reconstructions = reconstructions.clamp(0, 1)`
3. å¯èƒ½æ˜¯æ¨¡å‹è®­ç»ƒä¸ç¨³å®š

### 3. Range Mismatchï¼ˆèŒƒå›´ä¸åŒ¹é…ï¼‰

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ğŸŸ¡ [range_mismatch] Input range (0.98) differs from recon range (0.65)
```

**åŸå› **ï¼šé‡å»ºèŒƒå›´æ¯”è¾“å…¥èŒƒå›´çª„ï¼Œè¯´æ˜å¯¹æ¯”åº¦ä¸¢å¤±

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æé«˜`reconstruction_loss_weight`
2. æ£€æŸ¥decoderæ˜¯å¦æœ‰é—®é¢˜
3. æ£€æŸ¥æ¿€æ´»å‡½æ•°ï¼ˆå¦‚ä½¿ç”¨sigmoidï¼Œå¯èƒ½å‹ç¼©èŒƒå›´ï¼‰

### 4. High MSEï¼ˆé«˜é‡å»ºè¯¯å·®ï¼‰

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ğŸ”´ [high_mse] High MSE (0.1234) indicates poor reconstruction
```

**åŸå› **ï¼šé‡å»ºè´¨é‡å·®ï¼Œè¿™ç›´æ¥å¯¼è‡´PSNRä½

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æé«˜`reconstruction_loss_weight`ï¼ˆä»10.0åˆ°50.0ï¼‰
2. é™ä½å…¶ä»–lossæƒé‡
3. æ£€æŸ¥å­¦ä¹ ç‡æ˜¯å¦åˆé€‚
4. å¢åŠ è®­ç»ƒæ­¥æ•°

### 5. Narrow Recon Rangeï¼ˆé‡å»ºèŒƒå›´è¿‡çª„ï¼‰

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ğŸ”´ [narrow_recon_range] Reconstruction range (0.45) too narrow (input: 0.98)
```

**åŸå› **ï¼šæ¨¡å‹è¾“å‡ºèŒƒå›´å¤ªçª„ï¼Œä¸¢å¤±äº†ç»†èŠ‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥decoderçš„æœ€åä¸€å±‚æ¿€æ´»å‡½æ•°
2. å¦‚æœä½¿ç”¨sigmoidï¼Œè€ƒè™‘ç§»é™¤æˆ–æ”¹ç”¨å…¶ä»–æ¿€æ´»
3. æ£€æŸ¥normalizationå±‚

---

## ğŸ“Š TensorBoardå¯è§†åŒ–

æ•°æ®èŒƒå›´ä¿¡æ¯ä¼šè‡ªåŠ¨è®°å½•åˆ°TensorBoardï¼š

### æŸ¥çœ‹æ–¹å¼

```bash
tensorboard --logdir=logs/
```

### å¯ç”¨æŒ‡æ ‡

**è®­ç»ƒæŒ‡æ ‡**ï¼š
- `train/debug/input_min`
- `train/debug/input_max`
- `train/debug/input_mean`
- `train/debug/input_range`
- `train/debug/recon_min`
- `train/debug/recon_max`
- `train/debug/recon_mean`
- `train/debug/recon_range`
- `train/debug/mse`
- `train/debug/mae`

**éªŒè¯æŒ‡æ ‡**ï¼š
- `val/debug/input_min`
- `val/debug/input_max`
- `val/debug/input_range`
- `val/debug/recon_min`
- `val/debug/recon_max`
- `val/debug/recon_range`
- `val/debug/mse`
- `val/debug/mae`
- `val/debug/num_warnings`

### åˆ†ææŠ€å·§

1. **è§‚å¯Ÿè¶‹åŠ¿**ï¼š
   - `input_range`åº”è¯¥ç¨³å®šåœ¨0.95-1.0é™„è¿‘
   - `recon_range`åº”è¯¥ä¸`input_range`æ¥è¿‘

2. **å¯¹æ¯”è¾“å…¥å’Œé‡å»º**ï¼š
   - å¦‚æœ`recon_range`ä¸€ç›´å°äº`input_range` â†’ å¯¹æ¯”åº¦ä¸¢å¤±
   - å¦‚æœ`recon_mean`åç¦»`input_mean` â†’ äº®åº¦åç§»

3. **ç›‘æ§MSE**ï¼š
   - MSE < 0.01 â†’ é‡å»ºå¾ˆå¥½ï¼ˆPSNR > 40 dBï¼‰
   - MSE ~ 0.05 â†’ é‡å»ºä¸€èˆ¬ï¼ˆPSNR ~ 25-30 dBï¼‰
   - MSE > 0.1 â†’ é‡å»ºå¾ˆå·®ï¼ˆPSNR < 20 dBï¼‰

---

## ğŸ¯ å®é™…æ¡ˆä¾‹åˆ†æ

### æ¡ˆä¾‹1ï¼šPSNRåªæœ‰7 dBçš„é—®é¢˜

**åˆå§‹æ£€æŸ¥ç»“æœ**ï¼š
```
Input range: [0.0123, 0.9877]  âœ… æ­£å¸¸
Recon range: [0.4123, 0.5877]  âŒ èŒƒå›´å¤ªçª„ï¼
MSE: 0.15  âŒ å¾ˆé«˜ï¼

âš ï¸  [narrow_recon_range] Reconstruction range (0.18) too narrow (input: 0.98)
âš ï¸  [high_mse] High MSE (0.1500) indicates poor reconstruction
```

**é—®é¢˜è¯Šæ–­**ï¼š
- é‡å»ºèŒƒå›´åªæœ‰0.18ï¼Œè¾“å…¥èŒƒå›´æ˜¯0.98
- è¯´æ˜decoderè¾“å‡ºè¢«å‹ç¼©äº†
- å¯èƒ½æ˜¯sigmoidæ¿€æ´»å‡½æ•°çš„é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# æ£€æŸ¥decoderæœ€åä¸€å±‚
# å¦‚æœæ˜¯: output = torch.sigmoid(x)
# æ”¹ä¸º: output = x.clamp(0, 1)  æˆ–ç§»é™¤æ¿€æ´»å‡½æ•°
```

### æ¡ˆä¾‹2ï¼šè¾“å…¥æ•°æ®èŒƒå›´é”™è¯¯

**åˆå§‹æ£€æŸ¥ç»“æœ**ï¼š
```
Input range: [-0.9877, 0.9877]  âŒ ä¸æ˜¯[0,1]ï¼
Recon range: [0.0089, 0.9932]   âœ… æ­£å¸¸

âš ï¸  [input_range_abnormal] Input range [-0.99, 0.99] out of expected [0, 1]
âš ï¸  [range_mismatch] Input range (1.97) differs from recon range (0.98)
```

**é—®é¢˜è¯Šæ–­**ï¼š
- è¾“å…¥æ˜¯`[-1, 1]`èŒƒå›´ï¼Œä½†æ¨¡å‹æœŸæœ›`[0, 1]`
- æ•°æ®åŠ è½½æˆ–é¢„å¤„ç†æœ‰é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# è®­ç»ƒè„šæœ¬ä¸­
frames = batch.float() / 255.0  # [0, 1]
# å¦‚æœæ•°æ®å·²ç»æ˜¯[-1, 1]ï¼Œéœ€è¦è½¬æ¢
if frames.min() < 0:
    frames = (frames + 1) / 2  # [-1, 1] â†’ [0, 1]
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. è®­ç»ƒå‰æ£€æŸ¥

```bash
# å¯åŠ¨è®­ç»ƒå‰ï¼ŒæŸ¥çœ‹åˆå§‹æ£€æŸ¥ç»“æœ
bash train_taehv_h100.sh 8 custom training/configs/taehv_config_a800.py

# å¦‚æœå‘ç°é«˜ä¸¥é‡æ€§è­¦å‘Šï¼Œç«‹å³åœæ­¢ï¼ˆCtrl+Cï¼‰
# ä¿®å¤é—®é¢˜åé‡æ–°å¯åŠ¨
```

### 2. å®šæœŸç›‘æ§

```bash
# åœ¨TensorBoardä¸­ç›‘æ§æ•°æ®èŒƒå›´
tensorboard --logdir=logs/

# å…³æ³¨ï¼š
# - debug/input_range æ˜¯å¦ç¨³å®š
# - debug/recon_range æ˜¯å¦æ¥è¿‘input_range
# - debug/mse æ˜¯å¦ä¸‹é™
```

### 3. å‡ºç°é—®é¢˜æ—¶

```bash
# ä½¿ç”¨ç‹¬ç«‹è„šæœ¬è¯¦ç»†æ£€æŸ¥
python scripts/check_model_data_range.py \
    --model_path output/xxx/checkpoint-2000/model.pth \
    --config training/configs/taehv_config_a800.py \
    --num_samples 10 \
    --output_dir ./diagnostic_check

# æŸ¥çœ‹æ±‡æ€»
cat ./diagnostic_check/summary.json

# æŸ¥çœ‹è¯¦ç»†ç»“æœ
cat ./diagnostic_check/batch_0_result.json
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### Q1: æ£€æŸ¥è„šæœ¬æŠ¥é”™æ‰¾ä¸åˆ°æ•°æ®

**é”™è¯¯**ï¼š
```
âŒ Failed to load dataset: FileNotFoundError
```

**è§£å†³**ï¼š
```bash
# æ–¹æ³•1ï¼šæŒ‡å®šæ­£ç¡®çš„æ•°æ®è·¯å¾„
python scripts/check_model_data_range.py \
    --model_path xxx/model.pth \
    --config xxx/config.py \
    --data_root /correct/path/to/data \
    --annotation_file /correct/path/to/annotations.json

# æ–¹æ³•2ï¼šåˆ›å»ºå°çš„æµ‹è¯•æ•°æ®é›†
# åªéœ€è¦å‡ ä¸ªè§†é¢‘æ ·æœ¬ç”¨äºæ£€æŸ¥
```

### Q2: åˆå§‹æ£€æŸ¥å¤±è´¥

**é”™è¯¯**ï¼š
```
âŒ Initial data check failed: CUDA out of memory
```

**è§£å†³**ï¼š
```python
# ä¿®æ”¹æ£€æŸ¥æ—¶ä½¿ç”¨çš„æ ·æœ¬æ•°
# training/taehv_train.py ç¬¬593è¡Œ
encoded_check = model.encode_video(frames_check[:1], ...)  # ä»:2æ”¹ä¸º:1
```

### Q3: æ£€æŸ¥ç»“æœéƒ½æ˜¯warning

**æƒ…å†µ**ï¼šæ‰€æœ‰batchéƒ½æœ‰é«˜ä¸¥é‡æ€§è­¦å‘Š

**è§£å†³**ï¼š
1. è¿™è¯´æ˜å­˜åœ¨ç³»ç»Ÿæ€§é—®é¢˜
2. é‡ç‚¹æ£€æŸ¥æ•°æ®åŠ è½½å’Œæ¨¡å‹é…ç½®
3. è€ƒè™‘ä»å¤´å¼€å§‹è®­ç»ƒ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `docs/INFERENCE_AND_EVALUATION_GUIDE.md` - æ¨ç†ä¸è¯„ä¼°æµç¨‹
- `docs/TROUBLESHOOTING.md` - æ•…éšœæ’é™¤
- `training/utils/data_range_checker.py` - å®ç°ä»£ç 
- `scripts/check_model_data_range.py` - ç‹¬ç«‹æ£€æŸ¥è„šæœ¬

---

**æ€»ç»“**ï¼šæ•°æ®èŒƒå›´æ£€æŸ¥åŠŸèƒ½èƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹è®­ç»ƒä¸­çš„æ•°æ®é—®é¢˜ï¼Œæ˜¯è¯Šæ–­PSNRä½çš„å…³é”®å·¥å…·ã€‚å»ºè®®åœ¨è®­ç»ƒå¼€å§‹æ—¶å°±å…³æ³¨æ£€æŸ¥ç»“æœï¼ŒåŠæ—¶å‘ç°å¹¶è§£å†³é—®é¢˜ã€‚

